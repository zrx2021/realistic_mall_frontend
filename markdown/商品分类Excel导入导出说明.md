# 商品分类 Excel 导入导出功能说明

## 功能概述

商品分类管理提供了 Excel 导入导出功能，方便批量管理商品分类数据。支持一键导出现有分类，也支持通过 Excel 文件批量导入分类。

## 功能特性

- ✅ **Excel 导入**：支持 .xlsx 和 .xls 格式
- ✅ **Excel 导出**：一键导出所有分类数据
- ✅ **30秒超时**：导入导出操作最长等待30秒
- ✅ **实时反馈**：显示加载状态和进度提示
- ✅ **错误提示**：超时或失败时给出明确提示
- ✅ **文件校验**：上传前验证文件格式和大小

## 使用方法

### 1. 导出分类数据

1. 进入"商品管理" → "分类管理"页面
2. 点击顶部的"导出Excel"按钮
3. 系统会显示"正在导出分类数据，请稍候..."
4. 导出成功后会自动下载 Excel 文件
5. 文件名格式：`商品分类_时间戳.xlsx`

**导出内容包括：**
- 所有层级的分类数据
- 分类名称、排序权重、描述等信息
- 分类的层级关系

**超时处理：**
- 如果30秒内未完成，会提示"导出超时（30秒），数据量过大"
- 建议分批导出或联系管理员优化数据

### 2. 导入分类数据

1. 准备好符合格式的 Excel 文件
2. 点击"导入Excel"按钮
3. 选择要导入的 Excel 文件
4. 系统会显示"正在导入分类数据，请稍候..."
5. 导入成功后，分类列表会自动刷新

**文件要求：**
- 格式：.xlsx 或 .xls
- 大小：不超过 10MB
- 编码：UTF-8（避免中文乱码）

**超时处理：**
- 如果30秒内未完成，会提示"导入超时（30秒），请检查文件大小或网络连接"
- 建议减少数据量或优化文件格式

## Excel 文件格式说明

### 标准导出格式

导出的 Excel 文件通常包含以下列：

| 列名 | 说明 | 示例 |
|------|------|------|
| 分类ID | 分类唯一标识 | 1001 |
| 分类名称 | 分类的名称 | 手机数码 |
| 父分类ID | 上级分类ID，0表示一级分类 | 0 |
| 分类级别 | 1-10的层级 | 1 |
| 排序权重 | 数值越大越靠前 | 100 |
| 分类图标 | 图标URL | /file/image/... |
| 分类描述 | 描述信息 | 手机、数码产品 |
| 是否启用 | true/false | true |
| SEO标题 | SEO优化标题 | 手机数码商城 |
| SEO关键词 | SEO关键词 | 手机,数码 |
| SEO描述 | SEO描述 | 提供各类手机数码产品 |

### 导入文件格式要求

导入的 Excel 文件应遵循以下规则：

1. **必填字段**：
   - 分类名称（name）
   - 排序权重（sortOrder）

2. **可选字段**：
   - 父分类ID（parentId）：不填默认为一级分类
   - 分类图标（icon）
   - 分类描述（description）
   - 是否启用（isActive）：不填默认为 true
   - SEO相关字段

3. **数据格式**：
   - 数字类型：分类ID、父分类ID、排序权重、分类级别
   - 文本类型：分类名称、图标、描述、SEO字段
   - 布尔类型：是否启用（true/false、1/0、是/否）

4. **层级关系**：
   - 通过 parentId 建立父子关系
   - 确保父分类在子分类之前导入
   - 系统会自动计算分类级别和路径

### 示例文件

**简单示例（只包含必填字段）：**

| 分类名称 | 排序权重 |
|---------|---------|
| 手机数码 | 100 |
| 电脑办公 | 90 |
| 家用电器 | 80 |

**完整示例（包含所有字段）：**

| 分类名称 | 父分类ID | 排序权重 | 分类描述 | 是否启用 | SEO标题 |
|---------|---------|---------|---------|---------|---------|
| 手机数码 | 0 | 100 | 手机、数码产品 | 是 | 手机数码商城 |
| 智能手机 | 1 | 100 | 各品牌智能手机 | 是 | 智能手机专区 |

## 注意事项

### 1. 文件大小限制
- 单个文件不超过 10MB
- 建议每次导入分类数量不超过 1000 条
- 如果数据量大，建议分批导入

### 2. 超时设置
- 导入和导出操作超时时间为 30 秒
- 超时不代表操作失败，可能后端仍在处理
- 建议超时后等待片刻再刷新页面查看结果

### 3. 数据一致性
- 导入会追加数据，不会删除现有分类
- 相同名称的分类会被视为不同分类（除非ID相同）
- 建议导入前备份现有数据

### 4. 编码问题
- 请确保 Excel 文件使用 UTF-8 编码
- 如果出现中文乱码，请用 Excel 打开文件，另存为 UTF-8 格式

### 5. 错误处理
- 文件格式错误会在上传前提示
- 数据格式错误会在后端处理时返回具体错误信息
- 部分数据导入失败不影响其他数据

## API 接口说明

### 1. Excel 导入接口

```
POST /goods/category/import/excel
Content-Type: multipart/form-data

参数：
- file: Excel文件（.xlsx 或 .xls）

返回：
- 成功：返回导入成功的消息
- 失败：返回错误信息

超时：30秒
```

### 2. Excel 导出接口

```
GET /goods/category/export/excel
Content-Type: application/octet-stream

返回：
- 成功：返回 Excel 文件（Blob）
- 失败：返回错误信息

超时：30秒
```

## 前端实现细节

### 1. 请求超时配置

```typescript
// 导入请求（30秒超时）
return await upload<string>('/goods/category/import/excel', formData, {
  timeout: 30000, // 30秒超时
})

// 导出请求（30秒超时）
return get<Blob>('/goods/category/export/excel', {}, { 
  responseType: 'blob',
  timeout: 30000, // 30秒超时
})
```

### 2. 加载状态管理

```typescript
// 导入加载状态
const importLoading = ref(false)

// 导出加载状态
const exportLoading = ref(false)

// 显示加载提示
message.loading({ 
  content: '正在导入分类数据，请稍候...', 
  key: 'import', 
  duration: 0 // 持续显示直到操作完成
})
```

### 3. 超时错误判断

```typescript
// 判断是否是超时错误
if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {
  message.error({ 
    content: '导入超时（30秒），请检查文件大小或网络连接', 
    key: 'import', 
    duration: 3 
  })
}
```

### 4. 文件下载处理

```typescript
// 创建下载链接
const url = window.URL.createObjectURL(blob)
const link = document.createElement('a')
link.href = url
link.download = `商品分类_${new Date().getTime()}.xlsx`
document.body.appendChild(link)
link.click()

// 清理资源
document.body.removeChild(link)
window.URL.revokeObjectURL(url)
```

## 常见问题

### Q1: 导入时提示"只能上传Excel文件"？
A: 请确保文件扩展名是 .xlsx 或 .xls，且文件类型正确。

### Q2: 导入超时怎么办？
A: 
- 检查文件大小，建议不超过 10MB
- 减少导入的分类数量
- 检查网络连接
- 等待片刻后刷新页面查看是否导入成功

### Q3: 导出的文件中文乱码？
A: 用 Excel 打开文件时，选择"数据" → "获取外部数据" → "从文本"，指定 UTF-8 编码。

### Q4: 可以重复导入吗？
A: 可以，但会导致数据重复。建议导入前检查数据，避免重复。

### Q5: 导入失败会影响现有数据吗？
A: 不会。导入失败时不会修改现有数据，只有导入成功才会添加新数据。

### Q6: 如何批量修改现有分类？
A: 
1. 先导出现有分类数据
2. 在 Excel 中修改数据
3. 导入修改后的文件（需确保 ID 对应）

### Q7: 导入时如何建立分类层级关系？
A: 通过 parentId 字段指定父分类。确保父分类在子分类之前导入。

## 后端实现建议

### 1. Excel 解析库

推荐使用：
- Java: Apache POI
- Python: openpyxl, pandas
- Node.js: xlsx, exceljs

### 2. 导入逻辑

```
1. 接收文件
2. 验证文件格式和大小
3. 解析 Excel 数据
4. 验证数据完整性
5. 批量插入数据库
6. 返回导入结果
```

### 3. 导出逻辑

```
1. 查询所有分类数据
2. 按层级排序
3. 生成 Excel 文件
4. 返回文件流
```

### 4. 性能优化

- 使用批量插入提高效率
- 对大文件分批处理
- 添加异步任务处理机制
- 实现进度回调接口

## 更新日志

### v2.0.0 (2025-10-27)
- ✨ 重构为 Excel 导入导出功能
- ✨ 支持 .xlsx 和 .xls 格式
- ⚡ 设置30秒超时限制
- ⚡ 添加加载状态和进度提示
- ⚡ 优化错误提示和超时处理
- 🔧 文件大小限制为 10MB
- 📝 完善使用文档和格式说明

### v1.0.0 (2025-10-27)
- ✨ 预设批量导入功能（已废弃）

